name: Qlty Code Analysis

on:
  push:
    branches: [ main, dev, develop ]
  pull_request:
    branches: [ main, dev, develop ]

jobs:
  qlty:
    runs-on: ubuntu-latest
    name: Code Quality & Coverage Analysis

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Install Qlty CLI
        run: |
          curl -s https://qlty.sh | bash
          echo "$HOME/.qlty/bin" >> $GITHUB_PATH

      # ============================================
      # Setup Java for Spring Boot API
      # ============================================
      - name: Setup Java 25 (for API)
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'
          cache-dependency-path: apps/api/pom.xml

      # ============================================
      # Setup Node.js for Angular Frontend
      # ============================================
      - name: Setup Node.js (for Frontend)
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: apps/frontend/package-lock.json

      # ============================================
      # Install Dependencies
      # ============================================
      - name: Install Frontend dependencies
        run: cd apps/frontend && npm ci

      # ============================================
      # Run API Tests with Coverage (JaCoCo)
      # ============================================
      - name: Run API tests with coverage
        run: |
          cd apps/api
          ./mvnw test jacoco:report -q
          echo "API tests completed"
        continue-on-error: true

      # ============================================
      # Run Frontend Tests with Coverage (Vitest)
      # ============================================
      - name: Run Frontend tests with coverage
        run: |
          cd apps/frontend
          npm run test -- --run --coverage --coverage.reporter=lcov --coverage.reporter=cobertura --coverage.reporter=json-summary
        continue-on-error: true

      # ============================================
      # Collect and Organize Coverage Files
      # ============================================
      - name: Organize coverage files
        run: |
          mkdir -p coverage-reports

          # API coverage (JaCoCo XML format)
          if [ -f apps/api/target/site/jacoco/jacoco.xml ]; then
            cp apps/api/target/site/jacoco/jacoco.xml coverage-reports/api-coverage.xml
            echo "âœ“ API JaCoCo XML coverage found"
          fi

          # API coverage (JaCoCo CSV for additional metrics)
          if [ -f apps/api/target/site/jacoco/jacoco.csv ]; then
            cp apps/api/target/site/jacoco/jacoco.csv coverage-reports/api-coverage.csv
            echo "âœ“ API JaCoCo CSV coverage found"
          fi

          # Frontend coverage (LCOV format)
          if [ -f apps/frontend/coverage/lcov.info ]; then
            cp apps/frontend/coverage/lcov.info coverage-reports/frontend-coverage.lcov
            echo "âœ“ Frontend LCOV coverage found"
          fi

          # Frontend coverage (Cobertura XML format)
          if [ -f apps/frontend/coverage/cobertura-coverage.xml ]; then
            cp apps/frontend/coverage/cobertura-coverage.xml coverage-reports/frontend-coverage.xml
            echo "âœ“ Frontend XML coverage found"
          fi

          echo "## Coverage Files Generated" >> $GITHUB_STEP_SUMMARY
          echo "Available coverage files:" >> $GITHUB_STEP_SUMMARY
          ls -la coverage-reports/ >> $GITHUB_STEP_SUMMARY || echo "No coverage files found" >> $GITHUB_STEP_SUMMARY

      # ============================================
      # Run Qlty Check
      # ============================================
      - name: Run Qlty Check
        env:
          QLTY_COVERAGE_TOKEN: ${{ secrets.QLTY_COVERAGE_TOKEN }}
        run: |
          qlty check --summary --level medium

      # ============================================
      # Upload Coverage to Qlty
      # ============================================
      - name: Upload Coverage to Qlty
        uses: qltysh/qlty-action/coverage@v1
        if: always()
        with:
          token: ${{ secrets.QLTY_COVERAGE_TOKEN }}
          files: |
            coverage-reports/api-coverage.xml
            coverage-reports/frontend-coverage.xml
            coverage-reports/frontend-coverage.lcov
        continue-on-error: true

      # ============================================
      # Generate Coverage Summary
      # ============================================
      - name: Generate Coverage Summary
        if: always()
        run: |
          echo "## ğŸ“Š Coverage Summary" >> $GITHUB_STEP_SUMMARY

          # API coverage summary
          echo "### Spring Boot API Coverage" >> $GITHUB_STEP_SUMMARY
          if [ -f apps/api/target/site/jacoco/jacoco.xml ]; then
            echo "JaCoCo coverage report generated successfully." >> $GITHUB_STEP_SUMMARY
            # Parse and display coverage from CSV if available
            if [ -f apps/api/target/site/jacoco/jacoco.csv ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              head -5 apps/api/target/site/jacoco/jacoco.csv >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ No API coverage report generated" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Frontend coverage summary
          echo "### Angular Frontend Coverage" >> $GITHUB_STEP_SUMMARY
          if [ -f apps/frontend/coverage/coverage-summary.json ]; then
            echo "Vitest coverage report generated successfully." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat apps/frontend/coverage/coverage-summary.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No Frontend coverage report generated" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ˆ View detailed coverage reports on your [Qlty Dashboard](https://qlty.sh)" >> $GITHUB_STEP_SUMMARY

      # ============================================
      # Archive Coverage Artifacts
      # ============================================
      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: coverage-reports/
          retention-days: 30

      # ============================================
      # Run Qlty Analysis Summary
      # ============================================
      - name: Run Qlty Analysis Summary
        if: always()
        env:
          QLTY_COVERAGE_TOKEN: ${{ secrets.QLTY_COVERAGE_TOKEN }}
        run: |
          echo "## ğŸ” Qlty Code Analysis Results" >> $GITHUB_STEP_SUMMARY
          qlty check --summary --level medium >> $GITHUB_STEP_SUMMARY 2>&1 || true
