name: Qlty Code Analysis

on:
  push:
    branches: [ main, dev, develop ]
  pull_request:
    branches: [ main, dev, develop ]

jobs:
  qlty:
    runs-on: ubuntu-latest
    name: Code Quality & Coverage Analysis

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Qlty CLI
        run: |
          curl -s https://qlty.sh | bash
          echo "$HOME/.qlty/bin" >> $GITHUB_PATH

      - name: Setup Node.js (for Frontend)
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: apps/frontend/package-lock.json

      - name: Install Frontend dependencies
        run: cd apps/frontend && npm ci

      - name: Run Frontend tests with coverage
        run: |
          cd apps/frontend
          npx vitest run --coverage --coverage.reporter=lcov --coverage.reporter=cobertura --coverage.reporter=json-summary
        continue-on-error: true

      - name: Organize coverage files
        run: |
          mkdir -p coverage-reports

          if [ -f apps/frontend/coverage/lcov.info ]; then
            cp apps/frontend/coverage/lcov.info coverage-reports/frontend-coverage.lcov
            echo "âœ“ Frontend LCOV coverage found"
          fi

          if [ -f apps/frontend/coverage/cobertura-coverage.xml ]; then
            cp apps/frontend/coverage/cobertura-coverage.xml coverage-reports/frontend-coverage.xml
            echo "âœ“ Frontend XML coverage found"
          fi

          echo "## Coverage Files Generated" >> $GITHUB_STEP_SUMMARY
          echo "Available coverage files:" >> $GITHUB_STEP_SUMMARY
          ls -la coverage-reports/ >> $GITHUB_STEP_SUMMARY || echo "No coverage files found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸ **Note**: API coverage requires Java 25 which is not yet available in GitHub Actions." >> $GITHUB_STEP_SUMMARY

      - name: Run Qlty Check
        env:
          QLTY_COVERAGE_TOKEN: ${{ secrets.QLTY_COVERAGE_TOKEN }}
        run: |
          qlty check --summary --level medium

      - name: Upload Coverage to Qlty
        uses: qltysh/qlty-action/coverage@v1
        if: always()
        with:
          token: ${{ secrets.QLTY_COVERAGE_TOKEN }}
          files: |
            coverage-reports/frontend-coverage.xml
            coverage-reports/frontend-coverage.lcov
        continue-on-error: true

      - name: Generate Coverage Summary
        if: always()
        run: |
          echo "## ğŸ“Š Coverage Summary" >> $GITHUB_STEP_SUMMARY

          echo "### Angular Frontend Coverage" >> $GITHUB_STEP_SUMMARY
          if [ -f apps/frontend/coverage/coverage-summary.json ]; then
            echo "Vitest coverage report generated successfully." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat apps/frontend/coverage/coverage-summary.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No Frontend coverage report generated" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ˆ View detailed coverage reports on your [Qlty Dashboard](https://qlty.sh)" >> $GITHUB_STEP_SUMMARY

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: coverage-reports/
          retention-days: 30

      - name: Run Qlty Analysis Summary
        if: always()
        env:
          QLTY_COVERAGE_TOKEN: ${{ secrets.QLTY_COVERAGE_TOKEN }}
        run: |
          echo "## ğŸ” Qlty Code Analysis Results" >> $GITHUB_STEP_SUMMARY
          qlty check --summary --level medium >> $GITHUB_STEP_SUMMARY 2>&1 || true
